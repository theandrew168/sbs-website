<!doctype html><html lang=en><head><title>Two Go + PostgreSQL Timestamp Gotchas · Shallow Brook Software</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Andrew Dailey"><meta name=description content="This week I added some additional tests to my Bloggulus project.
In the process of doing so, I discovered a couple places where timestamp values weren&rsquo;t matching what was expected.
For some background, I generate, process, and store all timestamps in the UTC time standard.
The two gotchas were:

Unexpected conversion of UTC timestamps to local time
Mismatched precision between Go and PostgreSQL timestamps


  Unexpected Conversion
  
    
    Link to heading
  

I store timestamps in the database using PostgreSQL&rsquo;s timestamptz data type.
The problem I ran into was that even when I was inserting proper UTC timestamps (generated by Go&rsquo;s time package), they were being returned from the database in my local time zone.
What&rsquo;s going on?
Why are these UTC timestamps being converted to Central Standard Time when selected from the database?"><meta name=keywords content="blog,developer,personal"><meta name=fediverse:creator content><meta name=twitter:card content="summary"><meta name=twitter:title content="Two Go + PostgreSQL Timestamp Gotchas"><meta name=twitter:description content="This week I added some additional tests to my Bloggulus project. In the process of doing so, I discovered a couple places where timestamp values weren’t matching what was expected. For some background, I generate, process, and store all timestamps in the UTC time standard.
The two gotchas were:
Unexpected conversion of UTC timestamps to local time Mismatched precision between Go and PostgreSQL timestamps Unexpected Conversion Link to heading I store timestamps in the database using PostgreSQL’s timestamptz data type. The problem I ran into was that even when I was inserting proper UTC timestamps (generated by Go’s time package), they were being returned from the database in my local time zone. What’s going on? Why are these UTC timestamps being converted to Central Standard Time when selected from the database?"><meta property="og:url" content="https://shallowbrooksoftware.com/posts/two-go-plus-postgresql-timestamp-gotchas/"><meta property="og:site_name" content="Shallow Brook Software"><meta property="og:title" content="Two Go + PostgreSQL Timestamp Gotchas"><meta property="og:description" content="This week I added some additional tests to my Bloggulus project. In the process of doing so, I discovered a couple places where timestamp values weren’t matching what was expected. For some background, I generate, process, and store all timestamps in the UTC time standard.
The two gotchas were:
Unexpected conversion of UTC timestamps to local time Mismatched precision between Go and PostgreSQL timestamps Unexpected Conversion Link to heading I store timestamps in the database using PostgreSQL’s timestamptz data type. The problem I ran into was that even when I was inserting proper UTC timestamps (generated by Go’s time package), they were being returned from the database in my local time zone. What’s going on? Why are these UTC timestamps being converted to Central Standard Time when selected from the database?"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-06-30T00:00:00+00:00"><meta property="article:modified_time" content="2024-06-30T00:00:00+00:00"><meta property="article:tag" content="Databases"><meta property="article:tag" content="Go"><link rel=canonical href=https://shallowbrooksoftware.com/posts/two-go-plus-postgresql-timestamp-gotchas/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.e927f7340e309d76dcb8fda85f1531ae7341aa9cd0b7f3ab77885dae77b1a0a2.css integrity="sha256-6Sf3NA4wnXbcuP2oXxUxrnNBqpzQt/Ord4hdrnexoKI=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://shallowbrooksoftware.com/>Shallow Brook Software
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://shallowbrooksoftware.com/posts/two-go-plus-postgresql-timestamp-gotchas/>Two Go + PostgreSQL Timestamp Gotchas</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2024-06-30T00:00:00Z>June 30, 2024
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
5-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/databases/>Databases</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/go/>Go</a></span></div></div></header><div class=post-content><p>This week I added some additional tests to my <a href=https://github.com/theandrew168/bloggulus class=external-link target=_blank rel=noopener>Bloggulus</a> project.
In the process of doing so, I discovered a couple places where timestamp values weren&rsquo;t matching what was expected.
For some background, I generate, process, and store all timestamps in the <a href=https://en.wikipedia.org/wiki/Coordinated_Universal_Time class=external-link target=_blank rel=noopener>UTC time standard</a>.</p><p>The two gotchas were:</p><ol><li>Unexpected conversion of UTC timestamps to local time</li><li>Mismatched precision between Go and PostgreSQL timestamps</li></ol><h1 id=unexpected-conversion>Unexpected Conversion
<a class=heading-link href=#unexpected-conversion><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>I store timestamps in the database using PostgreSQL&rsquo;s <code>timestamptz</code> <a href=https://www.postgresql.org/docs/current/datatype-datetime.html class=external-link target=_blank rel=noopener>data type</a>.
The problem I ran into was that even when I was inserting proper UTC timestamps (generated by Go&rsquo;s <a href=https://pkg.go.dev/time class=external-link target=_blank rel=noopener>time</a> package), they were being returned from the database in my local time zone.
What&rsquo;s going on?
Why are these UTC timestamps being converted to Central Standard Time when selected from the database?</p><p>All of my Go projects use the amazing <a href=https://pkg.go.dev/github.com/jackc/pgx/v5 class=external-link target=_blank rel=noopener>pgx</a> driver for communicating with PostgreSQL databases.
After quite a bit of researching, I realized that I was not alone in experiencing this inconsistency.
Someone else noticed and opened a <a href=https://github.com/jackc/pgx/issues/1195 class=external-link target=_blank rel=noopener>GitHub issue</a> for <code>pgx/v4</code> back in 2022.
The intially-proposed solutions were a bit fussy (in my opinion) and involved creating a custom codec type for the <code>timestamptz</code> type.</p><p>Thankfully, enough time has passed that the package&rsquo;s author was able to include a more <a href=https://github.com/jackc/pgx/pull/1948 class=external-link target=_blank rel=noopener>convenient fix</a> in <code>pgx/v5</code>!
A new <code>ScanLocation</code> field was added to the <code>TimestamptzCodec</code> type that enables customization of what time zone <code>timestamptz</code> values are read into.</p><p>In short, I just needed to override the type&rsquo;s codec:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>config</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pgx</span>.<span style=color:#a6e22e>ParseConfig</span>(<span style=color:#a6e22e>uri</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pgx</span>.<span style=color:#a6e22e>ConnectConfig</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>config</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Ensure timestamps read from a timestamptz column retain their UTC location.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>TypeMap</span>().<span style=color:#a6e22e>RegisterType</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pgtype</span>.<span style=color:#a6e22e>Type</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span>:  <span style=color:#e6db74>&#34;timestamptz&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>OID</span>:   <span style=color:#a6e22e>pgtype</span>.<span style=color:#a6e22e>TimestamptzOID</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Codec</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pgtype</span>.<span style=color:#a6e22e>TimestamptzCodec</span>{<span style=color:#a6e22e>ScanLocation</span>: <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>UTC</span>},
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>The code is similar if using <a href=https://pkg.go.dev/github.com/jackc/pgx/v5/pgxpool class=external-link target=_blank rel=noopener>pgxpool</a> but we need to setup the override inside of the pool&rsquo;s <code>AfterConnect</code> hook:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>config</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pgxpool</span>.<span style=color:#a6e22e>ParseConfig</span>(<span style=color:#a6e22e>uri</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Ensure timestamps read from a timestamptz column retain their UTC location.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>AfterConnect</span> = <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>conn</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pgx</span>.<span style=color:#a6e22e>Conn</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>TypeMap</span>().<span style=color:#a6e22e>RegisterType</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pgtype</span>.<span style=color:#a6e22e>Type</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Name</span>:  <span style=color:#e6db74>&#34;timestamptz&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>OID</span>:   <span style=color:#a6e22e>pgtype</span>.<span style=color:#a6e22e>TimestamptzOID</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Codec</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pgtype</span>.<span style=color:#a6e22e>TimestamptzCodec</span>{<span style=color:#a6e22e>ScanLocation</span>: <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>UTC</span>},
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>pool</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pgxpool</span>.<span style=color:#a6e22e>NewWithConfig</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>config</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=digging-deeper>Digging Deeper
<a class=heading-link href=#digging-deeper><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Why did this happen in the first place?
Why is there even any ambiguity with respect to what time zone should be used when reading the timestamp from the database?
Isn&rsquo;t the time zone included with the timestamp since I&rsquo;m using <code>timestamptz</code>?</p><p>PostgreSQL offers two <a href=https://www.postgresql.org/docs/current/datatype-datetime.html class=external-link target=_blank rel=noopener>timestamp types</a>:</p><ol><li><code>timestamp without time zone</code> (aka <code>timestamp</code>)</li><li><code>timestamp with time zone</code> (aka <code>timestamptz</code>)</li></ol><p>When I starting building the app, I figured that <code>timestamptz</code> was what I wanted since my timestamps include a specific time zone: UTC (I&rsquo;ve since learned that UTC isn&rsquo;t really a time zone: it is a time standard).
I thought that the main difference between <code>timestamp</code> and <code>timestamptz</code> was that <code>timestamptz</code> stored a few extra bits of data to represent the timestamp&rsquo;s time zone.
However, that is <em>not</em> the case.</p><p>I dug deeper into the <a href=https://www.postgresql.org/docs/current/datatype-datetime.html#DATATYPE-DATETIME-INPUT-TIME-STAMPS class=external-link target=_blank rel=noopener>documentation</a> and found some important notes:</p><blockquote><p>For <code>timestamp with time zone</code>, the internally stored value is always in UTC (Universal Coordinated Time, traditionally known as Greenwich Mean Time, GMT).<br>&mldr;<br>When a timestamp with time zone value is output, it is always converted from UTC to the current timezone zone, and displayed as local time in that zone.</p></blockquote><p>It turns out that the <code>timestamptz</code> type does not work how I&rsquo;d originally assumed.
Instead, timestamps are checked for a time zone upon insertion but then converted to and stored as UTC.
The original time zone of the timestamp is lost after being normalized and inserted.
When selected, PostgreSQL converts <code>timestamptz</code> values to the database&rsquo;s configured timezone (which is correctly set to UTC in my case).</p><p>When pgx reads a <code>timestamptz</code> value from the database and converts it into Go&rsquo;s <code>time.Time</code> type, it has to make a decision about what to do with the stamp&rsquo;s time zone.
Should it be left as UTC or converted to the program&rsquo;s local time zone?
Historically, pgx unconditionally chose the latter.
But as of <code>v5</code>, the package now allows us to influence the decision.
Neat!</p><h1 id=mismatched-precision>Mismatched Precision
<a class=heading-link href=#mismatched-precision><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>This one is quite a bit simpler!
In short, Go’s timestamps are represented with nanosecond precision but PostgreSQL&rsquo;s only handle microseconds.
Therefore, you lose precision upon insertion and any logic that &ldquo;round-trips&rdquo; a Go timestamp to and from the database yields a different, less precise value at the end.
This hiccup has been <a href=https://stackoverflow.com/questions/60433870/saving-time-time-in-golang-to-postgres-timestamp-with-time-zone-field class=external-link target=_blank rel=noopener>discovered and discussed</a> before, too.
The suggestion from that question that made the most sense to me was to immediately round any timestamps generated by Go down to microsecond precision.</p><p>This, combined with defaulting all newly-created timestamps to UTC, led me to write a simple <code>timeutil</code> package to encapsulate the growing &ldquo;incantation&rdquo; required to generate a valid timestamp:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>timeutil</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Return the current UTC time rounded to microseconds (to match PostgreSQL).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Now</span>() <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>UTC</span>().<span style=color:#a6e22e>Round</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Microsecond</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=conclusion>Conclusion
<a class=heading-link href=#conclusion><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>That&rsquo;s all for today.
I figure that these &ldquo;gotchas&rdquo; could easily happen to someone else and were worth sharing.
At the end of the day, I learned something new and documenting the journey will help <em>me</em> remember the details someday.</p><p>Thanks for reading!</p></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2024
Andrew Dailey
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>