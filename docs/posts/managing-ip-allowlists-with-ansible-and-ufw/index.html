<!doctype html><html lang=en><head><title>Managing IP Allowlists with Ansible and UFW · Shallow Brook Software
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Andrew Dailey"><meta name=description content="I recently stood up a &ldquo;Golden Age&rdquo; minecraft server for my friends and me. We&rsquo;ve been having a great time so far building houses, cave bases, and clifftop observation decks. Despite the initial fun, I&rsquo;ve known that the server&rsquo;s security posture was a bit&mldr; shaky. The server only allows a specific set of usernames to login, but, since the old authentication servers aren&rsquo;t online anymore, the server has no choice but to trust the client."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Managing IP Allowlists with Ansible and UFW"><meta name=twitter:description content="I recently stood up a “Golden Age” minecraft server for my friends and me. We’ve been having a great time so far building houses, cave bases, and clifftop observation decks. Despite the initial fun, I’ve known that the server’s security posture was a bit… shaky. The server only allows a specific set of usernames to login, but, since the old authentication servers aren’t online anymore, the server has no choice but to trust the client."><meta property="og:url" content="https://shallowbrooksoftware.com/posts/managing-ip-allowlists-with-ansible-and-ufw/"><meta property="og:site_name" content="Shallow Brook Software"><meta property="og:title" content="Managing IP Allowlists with Ansible and UFW"><meta property="og:description" content="I recently stood up a “Golden Age” minecraft server for my friends and me. We’ve been having a great time so far building houses, cave bases, and clifftop observation decks. Despite the initial fun, I’ve known that the server’s security posture was a bit… shaky. The server only allows a specific set of usernames to login, but, since the old authentication servers aren’t online anymore, the server has no choice but to trust the client."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-02-11T00:00:00+00:00"><meta property="article:modified_time" content="2024-02-11T00:00:00+00:00"><meta property="article:tag" content="Minecraft"><meta property="article:tag" content="Ansible"><link rel=canonical href=https://shallowbrooksoftware.com/posts/managing-ip-allowlists-with-ansible-and-ufw/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.577e3c5ead537873430da16f0964b754a120fd87c4e2203a00686e7c75b51378.css integrity="sha256-V348Xq1TeHNDDaFvCWS3VKEg/YfE4iA6AGhufHW1E3g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://shallowbrooksoftware.com/>Shallow Brook Software
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://shallowbrooksoftware.com/posts/managing-ip-allowlists-with-ansible-and-ufw/>Managing IP Allowlists with Ansible and UFW</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2024-02-11T00:00:00Z>February 11, 2024
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
5-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/minecraft/>Minecraft</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/ansible/>Ansible</a></span></div></div></header><div class=post-content><p>I recently stood up a &ldquo;Golden Age&rdquo; minecraft server for my friends and me.
We&rsquo;ve been having a great time so far building houses, cave bases, and clifftop observation decks.
Despite the initial fun, I&rsquo;ve known that the server&rsquo;s security posture was a bit&mldr; shaky.
The server only allows a specific set of usernames to login, but, since the old authentication servers aren&rsquo;t online anymore, the server has no choice but to trust the client.</p><p>This means that a malicious / hacked client could spoof the username of a known player and immediately connect to the server.
I&rsquo;ve been doing my best to keep the players&rsquo; usernames secret but that is just &ldquo;security by obscurity&rdquo;.
I outlined some options to increase the server&rsquo;s security in my <a href=/posts/automating-a-golden-age-minecraft-server/>previous post</a> and one stood out as a clear winner: only allowing known IP addresses to connect.
Since the Minecraft server itself doesn&rsquo;t support this, I decided to move up a level and utilize the operating system&rsquo;s firewall: UFW.</p><h1 id=ufw>UFW
<a class=heading-link href=#ufw><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p><a href=https://help.ubuntu.com/community/UFW class=external-link target=_blank rel=noopener>UFW</a> has been the default firewall on Ubuntu servers since version 8.04 LTS.
It provides a user-friendly interface for managing open ports and is built on top of the classic <a href=https://linux.die.net/man/8/iptables class=external-link target=_blank rel=noopener>iptables</a> tool.
I&rsquo;ve read that some advanced users prefer to use iptables directly but I really like the balance that UFW offers.
It provides a simple syntax for restricting network access based protocol (TCP vs UDP), port, and source IP address.</p><p>Here is basic example that allows all incoming TCP connections on port 22 (SSH):</p><pre tabindex=0><code>ufw allow 22/tcp
</code></pre><p>Here is an iteration on the previous example that restricts SSH connections to <em>only</em> those coming from address <code>1.2.3.4</code>:</p><pre tabindex=0><code>ufw allow from 1.2.3.4 to any port 22 proto tcp
</code></pre><p>In addition to <code>allow</code>ing connections, you can also <code>limit</code> them which applies rate limiting with a simple strategy: block clients (by IP address) after 6 connection attempts within 30 seconds.
All of my servers already use this for limiting SSH access (pub-key auth is enforced so the rate limiting is mainly there to protect the server&rsquo;s CPU from all of the noise).</p><p>One last thing about UFW: even though it ships with Ubuntu, it is disabled by default.
Enabling it is as easy as running <code>ufw enable</code> but be careful!
If you don&rsquo;t have any rules in place when the firewall comes up, you could lock yourself out of the system.
Unless you are using a hosting provider that supports native consoles, you&rsquo;ll be unable to connect.
I learned this lesson the hard way: be sure to allow SSH connections <em>before</em> enabling UFW.
These days, I use automation (<a href=https://www.terraform.io/ class=external-link target=_blank rel=noopener>Terraform</a> and <a href=https://www.ansible.com/ class=external-link target=_blank rel=noopener>Ansible</a>) to ensure that these operations always occur in the correct order.</p><h1 id=ansible>Ansible
<a class=heading-link href=#ansible><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>Ansible has a <a href=https://docs.ansible.com/ansible/latest/collections/community/general/ufw_module.html class=external-link target=_blank rel=noopener>builtin module</a> for idempotently configuring UFW.
The examples in the documentation are very thorough and even describe setting up rules for multiple source IPs!
To my <a href=https://github.com/theandrew168/devops/tree/master/roles/minecraft class=external-link target=_blank rel=noopener>Minecraft role</a> I added a variable named <code>minecraft_allowed_ips</code> which is a simple list of IP addresses (or ranges) that are allowed to access the server.
When this list is present and non-empty, a UFW rule should be created <strong>per address</strong> that allows it to connect to port 25565.
When the list is empty, all connections should be allowed regardless of where they are coming from.</p><p>With a small bit of Ansible logic we can split the task into these two cases: one for permitting <em>specific</em> IPs and one for permitting <em>all</em> IPs:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Limit login attempts (allowed IP addresses)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ufw</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>rule</span>: <span style=color:#ae81ff>limit</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>src</span>: <span style=color:#e6db74>&#34;{{ item }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>port</span>: <span style=color:#e6db74>&#34;25565&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>proto</span>: <span style=color:#ae81ff>tcp</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>with_items</span>: <span style=color:#e6db74>&#34;{{ minecraft_allowed_ips }}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>no_log</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>become</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>become_user</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Limit login attempts (all IP addresses)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ufw</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>rule</span>: <span style=color:#ae81ff>limit</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>port</span>: <span style=color:#e6db74>&#34;25565&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>proto</span>: <span style=color:#ae81ff>tcp</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>not minecraft_allowed_ips</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>become</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>become_user</span>: <span style=color:#ae81ff>root</span>
</span></span></code></pre></div><p>The combination of <code>when</code> and <code>with_items</code> partitions the control flow such that only one of these tasks will run.
In tandem, these tasks cleanly handle configuring servers that are either &ldquo;open to just me and my friends&rdquo; or &ldquo;open to anyone&rdquo;.</p><h1 id=conclusion>Conclusion
<a class=heading-link href=#conclusion><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>Overall, these changes were <a href=https://github.com/theandrew168/devops/commit/9aa74693962d3e2b3a655ddde68eeb59bfcc4e12 class=external-link target=_blank rel=noopener>fairly straightforward to implement</a> and increased my confidence that my golden age Minecraft server won&rsquo;t get compromised.
In total, it now has three layers of security:</p><ol><li>Only specific usernames can connect (via the server&rsquo;s config)</li><li>Only specific IP addresses can connect (via UFW)</li><li>Connection attempts are rate limited (via UFW)</li></ol><p>Even still, though, this isn&rsquo;t a bulletproof solution.
A bad actor could gain access to the server if they: had a hacked client, knew a valid username, and were connecting to server from an allowed IP address / range (perhaps this could happen if both the attacker and an allowed player were behind the same <a href=https://www.rapidseedbox.com/blog/cgnat class=external-link target=_blank rel=noopener>CGNAT</a>).
I don&rsquo;t think is very likely but it <em>could</em> happen.</p><p>That being said, this is just a Minecraft server.
Between the low stakes of the system itself, periodic backups of the data volume, and ease of deployment, I&rsquo;m not super worried.
The security layers in place might not be perfect but they do save me from losing sleep about it.
I can rest easy knowing that my precious blocks are (probably) safe and sound.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2024
Andrew Dailey
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>