<!doctype html><html lang=en><head><title>Testing with Transactions · Shallow Brook Software
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Andrew Dailey"><meta name=description content="Most web applications eventually end up with tests that need to interact with a database. Perhaps your business logic is tightly coupled to the database or maybe you are wanting to test a clearly-defined storage layer. Either way, a common problem arises: how do you clean up the data used during testing? What should you do with all those scattered rows?
Most of the time, developers will resort to a few common strategies:"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Testing with Transactions"><meta name=twitter:description content="Most web applications eventually end up with tests that need to interact with a database. Perhaps your business logic is tightly coupled to the database or maybe you are wanting to test a clearly-defined storage layer. Either way, a common problem arises: how do you clean up the data used during testing? What should you do with all those scattered rows?
Most of the time, developers will resort to a few common strategies:"><meta property="og:url" content="https://shallowbrooksoftware.com/posts/testing-with-transactions/"><meta property="og:site_name" content="Shallow Brook Software"><meta property="og:title" content="Testing with Transactions"><meta property="og:description" content="Most web applications eventually end up with tests that need to interact with a database. Perhaps your business logic is tightly coupled to the database or maybe you are wanting to test a clearly-defined storage layer. Either way, a common problem arises: how do you clean up the data used during testing? What should you do with all those scattered rows?
Most of the time, developers will resort to a few common strategies:"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-24T00:00:00+00:00"><meta property="article:modified_time" content="2024-03-24T00:00:00+00:00"><meta property="article:tag" content="Go"><meta property="article:tag" content="TypeScript"><meta property="article:tag" content="Databases"><link rel=canonical href=https://shallowbrooksoftware.com/posts/testing-with-transactions/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.577e3c5ead537873430da16f0964b754a120fd87c4e2203a00686e7c75b51378.css integrity="sha256-V348Xq1TeHNDDaFvCWS3VKEg/YfE4iA6AGhufHW1E3g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://shallowbrooksoftware.com/>Shallow Brook Software
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://shallowbrooksoftware.com/posts/testing-with-transactions/>Testing with Transactions</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2024-03-24T00:00:00Z>March 24, 2024
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
5-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/go/>Go</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/typescript/>TypeScript</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/databases/>Databases</a></span></div></div></header><div class=post-content><p>Most web applications eventually end up with tests that need to interact with a database.
Perhaps your business logic is tightly coupled to the database or maybe you are wanting to test a clearly-defined storage layer.
Either way, a common problem arises: how do you clean up the data used during testing? What should you do with all those scattered rows?</p><p>Most of the time, developers will resort to a few common strategies:</p><ol><li>Cleanup the database after (or before) each integration test runs<ol><li>Can become very slow depending on the size of your database</li><li>Can be optimized (somewhat) by only deleting tables that changed</li><li>Could indicate that your tests must be ran serially (concurrency could cause conflicts)</li></ol></li><li>Cleanup the database after (or before) <em>all</em> integration tests have been ran<ol><li>Much quicker than wiping everything for each test</li><li>This requires that all tests &ldquo;play nice&rdquo; and don&rsquo;t cause any data conflicts</li></ol></li><li>Use an ephemeral database for each test<ol><li>Newer libraries such as <a href=https://golang.testcontainers.org/ class=external-link target=_blank rel=noopener>testcontainers</a> have made this much easier</li><li>Not a bad idea, but I want a solution with more speed and less complexity</li></ol></li></ol><p>I want to present a better solution to <em>all</em> of these strategies that depends only on a feature that is aleady at our fingertips: the humble <strong>transaction</strong>.</p><h1 id=commits-and-rollbacks>Commits and Rollbacks
<a class=heading-link href=#commits-and-rollbacks><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>At a high level, database transactions are a feature that let you group a set of changes into an atomic operation that either <em>all</em> succeed (and get committed to the database) or <em>all</em> fail (and get rolled back as though they never happened).
The core idea is this: run your tests inside of a transaction and then roll it back (intentionally) when you are done.</p><p>That&rsquo;s it!
With this simple idea, you can verify that your storage layer is working as intended and not have to worry about the cleanup.
Additionally, you can run your database-related tests concurrently without having to worry about conflicts because the changes inside of each test (and therefore each transaction) will never &ldquo;see&rdquo; each other.</p><h1 id=in-practice>In Practice
<a class=heading-link href=#in-practice><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>In order to support arbitrary transactions within the confines of the <a href=https://medium.com/@pererikbergman/repository-design-pattern-e28c0f3e4a30 class=external-link target=_blank rel=noopener>repository pattern</a>, I like to attach an extra method to my storage class / struct / interface called something like <code>Transaction</code>, <code>WithTransaction</code> or <code>Atomically</code> (I&rsquo;m still undecided on which name I like best).
This method accepts a function that requires a single argument: an instance of the storage &ldquo;object&rdquo;.
The function is also expected to either <em>return</em> an error (in languages like Go) or <em>throw</em> an error (in languages like TypeScript) if something goes wrong.
A transaction is started before calling the given function and is automatically rolled back if an error occurs.
Otherwise, it commits the transaction like normal and permanently saves our changes to the database.</p><p>In my projects, I like to add a special sentinel error (usually called <code>ErrRollback</code> or <code>RollbackError</code>) that indicates to the reader that the error is being used <em>specifically</em> to prevent the transaction from committing.
In TypeScript projects, I also check for this error and prevent it from propagating any higher.
As long as the <a href=https://github.com/porsager/postgres class=external-link target=_blank rel=noopener>postgres library</a> sees the error first and rolls back the commit, it has served its purpose.</p><h3 id=typescript>TypeScript
<a class=heading-link href=#typescript><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>This <a href=https://github.com/theandrew168/bloggulus-svelte/blob/3c0572d736c2e3d97fa36a56bcbe6b9ec951f254/src/lib/server/storage/storage.ts#L27 class=external-link target=_blank rel=noopener>example</a> is using the <a href=https://github.com/porsager/postgres class=external-link target=_blank rel=noopener>postgres</a> library.
It exposes a <a href="https://github.com/porsager/postgres?tab=readme-ov-file#transactions" class=external-link target=_blank rel=noopener>begin</a> utility which automatically rolls back the transaction if any errors are thrown from the lambda it was given.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Storage</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>async</span> <span style=color:#a6e22e>transaction</span>(<span style=color:#a6e22e>operation</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>storage</span>: <span style=color:#66d9ef>Storage</span>) <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt;) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Calling begin() will start a new database transaction and automatically
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// roll it back if any errors are thrown from the given lambda.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>begin</span>(<span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>tx</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// Create a new instance of the Storage class using this transaction.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>storage</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Storage</span>(<span style=color:#a6e22e>tx</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>// Use the transaction-based Storage class for this atomic operation.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#75715e>// If an error occurs within this operation, the transaction will
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#75715e>// be rolled back.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#66d9ef>await</span> <span style=color:#a6e22e>operation</span>(<span style=color:#a6e22e>storage</span>);
</span></span><span style=display:flex><span>			});
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>e</span>) {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Check for our special sentinel error and prevent it from propagating
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// if found. All other errors should continue to bubble up.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>isRollbackError</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>e</span> <span style=color:#66d9ef>instanceof</span> <span style=color:#a6e22e>RollbackError</span>;
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>isRollbackError</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>throw</span> <span style=color:#a6e22e>e</span>;
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This allows me to write code like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#75715e>// create a Foo within a transaction and then roll it back
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>transaction</span>(<span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>store</span>: <span style=color:#66d9ef>Storage</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>await</span> <span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>foo</span>.<span style=color:#a6e22e>Create</span>(...)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>RollbackError</span>();
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><h3 id=go>Go
<a class=heading-link href=#go><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>This is <a href=https://github.com/theandrew168/bloggulus/blob/eba4fee0f7083fe75b56e86bfb9033fe42c11e10/backend/storage/storage.go#L30 class=external-link target=_blank rel=noopener>example</a> is using the <a href=https://github.com/jackc/pgx class=external-link target=_blank rel=noopener>pgx</a> library which requires a slightly more &ldquo;hands-on&rdquo; approach to <a href=https://pkg.go.dev/github.com/jackc/pgx/v5#hdr-Transactions class=external-link target=_blank rel=noopener>managing the transaction</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Storage</span> <span style=color:#66d9ef>struct</span> = {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Storage</span>) <span style=color:#a6e22e>WithTransaction</span>(<span style=color:#a6e22e>operation</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>store</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Storage</span>) <span style=color:#66d9ef>error</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Calling the Begin() method on the connection creates a new pgx.Tx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// object, which represents the in-progress database transaction.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>tx</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Begin</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Defer a call to tx.Rollback() to ensure it is always called before the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// function returns. If the transaction succeeds it will be already be
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// committed by the time tx.Rollback() is called, making tx.Rollback() a
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// no-op. Otherwise, in the event of an error, tx.Rollback() will rollback
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// the changes before the function returns.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>Rollback</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Create a new Storage struct using the pgx.Tx as its Conn.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>store</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>tx</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Use the pgx.Tx-based Storage struct for this atomic operation.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// If an error occurs within this operation, the transaction will
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// be rolled back.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>operation</span>(<span style=color:#a6e22e>store</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// If there are no errors, the operation can be committed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// to the database with the tx.Commit() method.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>tx</span>.<span style=color:#a6e22e>Commit</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This allows me to write code like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// create a Foo within a transaction and then roll it back
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>WithTransaction</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>store</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>storage</span>.<span style=color:#a6e22e>Storage</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>Foo</span>.<span style=color:#a6e22e>Create</span>(<span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ErrRollback</span>;
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><h1 id=conclusion>Conclusion
<a class=heading-link href=#conclusion><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>There you have it!
This is one of my favorite programming patterns that I&rsquo;ve discovered so far in 2024.
If your code is structured such that all database interactions can be managed within explicit transactions, then this trick can be introduced and adapted to fit your needs.
Gone are the days of wiping the database before / after tests run: you can simply rollback and forget!</p></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2024
Andrew Dailey
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>