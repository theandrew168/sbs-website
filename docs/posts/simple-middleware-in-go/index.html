<!doctype html><html lang=en><head><title>Simple Middleware in Go · Shallow Brook Software
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Andrew Dailey"><meta name=description content="Since Go released its HTTP routing enhancements in version 1.22, I&rsquo;ve been quick to migrate.
If you want to learn more about these changes, Eli Bendersky wrote up a great article on the subject.
While Alex Edwards&rsquo; Flow router has served me well (pun intended) for years, I tend to prefer using the standard library whenever possible.
However, one feature that Go&rsquo;s http.ServeMux lacks is convenient support for middleware."><meta name=keywords content="blog,developer,personal"><meta name=fediverse:creator content><meta name=twitter:card content="summary"><meta name=twitter:title content="Simple Middleware in Go"><meta name=twitter:description content="Since Go released its HTTP routing enhancements in version 1.22, I’ve been quick to migrate. If you want to learn more about these changes, Eli Bendersky wrote up a great article on the subject. While Alex Edwards’ Flow router has served me well (pun intended) for years, I tend to prefer using the standard library whenever possible. However, one feature that Go’s http.ServeMux lacks is convenient support for middleware."><meta property="og:url" content="https://shallowbrooksoftware.com/posts/simple-middleware-in-go/"><meta property="og:site_name" content="Shallow Brook Software"><meta property="og:title" content="Simple Middleware in Go"><meta property="og:description" content="Since Go released its HTTP routing enhancements in version 1.22, I’ve been quick to migrate. If you want to learn more about these changes, Eli Bendersky wrote up a great article on the subject. While Alex Edwards’ Flow router has served me well (pun intended) for years, I tend to prefer using the standard library whenever possible. However, one feature that Go’s http.ServeMux lacks is convenient support for middleware."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-09-08T00:00:00+00:00"><meta property="article:modified_time" content="2024-09-08T00:00:00+00:00"><meta property="article:tag" content="Go"><link rel=canonical href=https://shallowbrooksoftware.com/posts/simple-middleware-in-go/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.e927f7340e309d76dcb8fda85f1531ae7341aa9cd0b7f3ab77885dae77b1a0a2.css integrity="sha256-6Sf3NA4wnXbcuP2oXxUxrnNBqpzQt/Ord4hdrnexoKI=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://shallowbrooksoftware.com/>Shallow Brook Software
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://shallowbrooksoftware.com/posts/simple-middleware-in-go/>Simple Middleware in Go</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2024-09-08T00:00:00Z>September 8, 2024
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
5-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/go/>Go</a></span></div></div></header><div class=post-content><p>Since Go released its <a href=https://go.dev/blog/routing-enhancements class=external-link target=_blank rel=noopener>HTTP routing enhancements</a> in version 1.22, I&rsquo;ve been quick to migrate.
If you want to learn more about these changes, Eli Bendersky wrote up a <a href=https://eli.thegreenplace.net/2023/better-http-server-routing-in-go-122 class=external-link target=_blank rel=noopener>great article</a> on the subject.
While Alex Edwards&rsquo; <a href=https://github.com/alexedwards/flow class=external-link target=_blank rel=noopener>Flow</a> router has served me well (pun intended) for years, I tend to prefer using the standard library whenever possible.
However, one feature that Go&rsquo;s <a href=https://pkg.go.dev/net/http#ServeMux class=external-link target=_blank rel=noopener>http.ServeMux</a> lacks is convenient support for middleware.</p><h2 id=middleware>Middleware
<a class=heading-link href=#middleware><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p><strong>Middleware is code that runs between incoming (or outgoing) HTTP requests and your handlers.</strong>
It can be used for all sorts of things: handling panics, adding headers, compressing files, or verifying authenication.
Writing these chunks of logic as middleware allows for great flexibility and readability (as we&rsquo;ll soon see).
As far as the code goes, middleware is typically written as a function that both accepts and returns Go&rsquo;s most important HTTP interface: the <a href=https://pkg.go.dev/net/http#Handler class=external-link target=_blank rel=noopener>http.Handler</a>.</p><p>As a type, one could represent middleware like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Represents a piece of HTTP middleware.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Middleware</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Handler</span>) <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Handler</span>
</span></span></code></pre></div><p>It accepts a handler and returns a &ldquo;wrapped&rdquo; version of the handler with added effects.
Here is an example of basic middleware that adds a few headers to the response:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>SecureHeaders</span>() <span style=color:#a6e22e>Middleware</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>next</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Handler</span>) <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Handler</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandlerFunc</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;Referrer-Policy&#34;</span>, <span style=color:#e6db74>&#34;origin-when-cross-origin&#34;</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;X-Content-Type-Options&#34;</span>, <span style=color:#e6db74>&#34;nosniff&#34;</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;X-Frame-Options&#34;</span>, <span style=color:#e6db74>&#34;deny&#34;</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;X-XSS-Protection&#34;</span>, <span style=color:#e6db74>&#34;0&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>next</span>.<span style=color:#a6e22e>ServeHTTP</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Using this <code>Middleware</code> type as a focus, I&rsquo;ve come to appreciate two specific helpers (<code>Use</code> and <code>Chain</code>) that are inspired by Mat Ryer&rsquo;s <a href=https://medium.com/@matryer/writing-middleware-in-golang-and-how-go-makes-it-so-much-fun-4375c1246e81 class=external-link target=_blank rel=noopener>middleware pattern</a>.
Let&rsquo;s dive into the first one.</p><h2 id=use>Use
<a class=heading-link href=#use><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>This helper allows us to use multiple pieces of middleware on a single <code>http.Handler</code>.
Often, that handler will be an HTTP router of some sort (like Go&rsquo;s <code>http.ServeMux</code> in my case).
Note how the middleware functions are applied in reverse order.
I&rsquo;ll go into more detail about that nuance soon.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Apply a sequence of middleware to a handler (in the provided order).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Use</span>(<span style=color:#a6e22e>h</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Handler</span>, <span style=color:#a6e22e>mws</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>Middleware</span>) <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Handler</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Due to how these functions wrap the handler, we apply them
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// in reverse order so that the first one supplied is the first
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// one that runs.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> len(<span style=color:#a6e22e>mws</span>) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>--</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>h</span> = <span style=color:#a6e22e>mws</span>[<span style=color:#a6e22e>i</span>](<span style=color:#a6e22e>h</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>h</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Here&rsquo;s what the <code>Use</code> helper looks like in action:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Apply global middleware to all routes.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>handler</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>middleware</span>.<span style=color:#a6e22e>Use</span>(<span style=color:#a6e22e>mux</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>middleware</span>.<span style=color:#a6e22e>RecoverPanic</span>(),
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>middleware</span>.<span style=color:#a6e22e>CompressFiles</span>(),
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>middleware</span>.<span style=color:#a6e22e>SecureHeaders</span>(),
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>middleware</span>.<span style=color:#a6e22e>LimitRequestBodySize</span>(),
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>middleware</span>.<span style=color:#a6e22e>Authenticate</span>(<span style=color:#a6e22e>repo</span>),
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>I find this to be incredibly readable!
<strong>It is very clear what middleware is being applied and the order in which they will run.</strong>
In my case, I want <code>RecoverPanic</code> to be the first middleware to execute since anything downstream (even other middleware) could cause a panic.
Having it first means that I&rsquo;ll always be able to catch and response to any panics that occur.</p><h2 id=chain>Chain
<a class=heading-link href=#chain><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>The second helper is slightly different than the first.
While it still accepts multiple pieces of middleware and connects them together, it delays the actual application to an <code>http.Handler</code> until later.
This can be useful when you have groups of middleware that need to be applied more precisely to specific routes.
This helper is conveniently implemented in terms of the aforementioned <code>Use</code> function.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Chain multiple middleware together for delayed application to a handler.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Chain</span>(<span style=color:#a6e22e>mws</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>Middleware</span>) <span style=color:#a6e22e>Middleware</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>h</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Handler</span>) <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Handler</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Use</span>(<span style=color:#a6e22e>h</span>, <span style=color:#a6e22e>mws</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In <a href=https://bloggulus.com/ class=external-link target=_blank rel=noopener>Bloggulus</a>, for example, some routes require the user to have an account while other require the user to both have an account <em>and</em> be an admin.
Since checking if an account is an admin depends on having an account in the first place, it means that <em>both</em> middleware must be applied.
The <code>Chain</code> helper let&rsquo;s us express that dependency once and then reuse the pre-connected pieces.
Here&rsquo;s what that looks like in code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>accountRequired</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>middleware</span>.<span style=color:#a6e22e>AccountRequired</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>adminRequired</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>middleware</span>.<span style=color:#a6e22e>Chain</span>(<span style=color:#a6e22e>accountRequired</span>, <span style=color:#a6e22e>middleware</span>.<span style=color:#a6e22e>AdminRequired</span>())
</span></span><span style=display:flex><span><span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>Handle</span>(<span style=color:#e6db74>&#34;GET /blogs&#34;</span>, <span style=color:#a6e22e>accountRequired</span>(<span style=color:#a6e22e>HandleBlogList</span>(<span style=color:#a6e22e>find</span>)))
</span></span><span style=display:flex><span><span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>Handle</span>(<span style=color:#e6db74>&#34;POST /blogs/follow&#34;</span>, <span style=color:#a6e22e>accountRequired</span>(<span style=color:#a6e22e>HandleBlogFollowForm</span>(<span style=color:#a6e22e>repo</span>, <span style=color:#a6e22e>find</span>)))
</span></span><span style=display:flex><span><span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>Handle</span>(<span style=color:#e6db74>&#34;POST /blogs/unfollow&#34;</span>, <span style=color:#a6e22e>accountRequired</span>(<span style=color:#a6e22e>HandleBlogUnfollowForm</span>(<span style=color:#a6e22e>repo</span>, <span style=color:#a6e22e>find</span>)))
</span></span><span style=display:flex><span><span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>Handle</span>(<span style=color:#e6db74>&#34;GET /blogs/{blogID}&#34;</span>, <span style=color:#a6e22e>adminRequired</span>(<span style=color:#a6e22e>HandleBlogRead</span>(<span style=color:#a6e22e>repo</span>)))
</span></span><span style=display:flex><span><span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>Handle</span>(<span style=color:#e6db74>&#34;POST /blogs/{blogID}/delete&#34;</span>, <span style=color:#a6e22e>adminRequired</span>(<span style=color:#a6e22e>HandleBlogDeleteForm</span>(<span style=color:#a6e22e>repo</span>)))
</span></span></code></pre></div><h2 id=ordering>Ordering
<a class=heading-link href=#ordering><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>An important detail to note when applying middleware is how their &ldquo;wrapping&rdquo; behavior affects the order in which they run.
To put things another way, the <em>first</em> middleware that wraps your handler will be the <em>last</em> one to execute (since all subsequently-applied middleware will execute before it).</p><p>For example, say we want to apply the following middleware to a handler (in this order).
When request arrive at our server, we want &ldquo;foo&rdquo; to run first, then &ldquo;bar&rdquo;, and lastly &ldquo;baz&rdquo;.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>mws <span style=color:#f92672>=</span> [foo, bar, baz]
</span></span></code></pre></div><p>Applying the middleware in the provided order would yield a call chain that is NOT what we expected.
In fact, it is the opposite of what we want: incoming requests would hit &ldquo;baz&rdquo; first.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>for</span> mw <span style=color:#f92672>in</span> mws:
</span></span><span style=display:flex><span>	h <span style=color:#f92672>=</span> mw(h)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>h <span style=color:#f92672>=</span> baz(bar(foo(h)))
</span></span><span style=display:flex><span><span style=color:#75715e>#   ^ requests will hit &#34;baz&#34; first</span>
</span></span></code></pre></div><p>However, applying the middleware in the <em>reverse</em> order will achieve what we want.
This new call chain will cause incoming requests to hit &ldquo;foo&rdquo; first.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>for</span> mw <span style=color:#f92672>in</span> reversed(mws):
</span></span><span style=display:flex><span>	h <span style=color:#f92672>=</span> mw(h)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>h <span style=color:#f92672>=</span> foo(bar(baz(h)))
</span></span><span style=display:flex><span><span style=color:#75715e>#   ^ requests will hit &#34;foo&#34; first</span>
</span></span></code></pre></div><h2 id=conclusion>Conclusion
<a class=heading-link href=#conclusion><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>It doesn&rsquo;t take much code to create an incredibly useful and versatile middleware system.
In fact, the <a href=https://github.com/theandrew168/bloggulus/blob/4de1abef12ca9a9ef3651b8928d3aeac768b0359/backend/web/middleware/middleware.go class=external-link target=_blank rel=noopener>entire file</a> containing these helpers is only 30 lines (many of which are comments).
Feel free to try them out in your own Go web application.
Also, if you aren&rsquo;t using Go 1.22&rsquo;s enhanced router yet, try that out as well!
After navigating a small learning curve, I&rsquo;ve come to really enjoy using it.
Plus, having fewer dependencies is always nice.</p><p>Thanks for reading!</p></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2024
Andrew Dailey
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>